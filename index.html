<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #2a2a2a;
            padding: 1rem;
            border-bottom: 1px solid #444;
        }
        
        .config {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .config input, .config select, .config button {
            padding: 0.5rem;
            border: 1px solid #444;
            background: #333;
            color: #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .config input {
            flex: 1;
            min-width: 300px;
        }
        
        .config button {
            background: #0066cc;
            color: white;
            cursor: pointer;
            font-weight: 500;
        }
        
        .config button:hover {
            background: #0052a3;
        }
        
        .config button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .status {
            font-size: 12px;
            color: #888;
            margin-top: 0.5rem;
        }
        
        .status.connected {
            color: #4ade80;
        }
        
        .status.error {
            color: #ef4444;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .message.user {
            align-self: flex-end;
            background: #0066cc;
            color: white;
        }
        
        .message.assistant {
            align-self: flex-start;
            background: #2a2a2a;
            border: 1px solid #444;
        }
        
        .message.system {
            align-self: center;
            background: #1e3a5f;
            font-size: 12px;
            font-style: italic;
            max-width: 60%;
        }
        
        .input-container {
            background: #2a2a2a;
            border-top: 1px solid #444;
            padding: 1rem;
            display: flex;
            gap: 1rem;
        }
        
        .input-container textarea {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #444;
            background: #333;
            color: #e0e0e0;
            border-radius: 4px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            min-height: 60px;
        }
        
        .input-container button {
            padding: 0.75rem 1.5rem;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }
        
        .input-container button:hover:not(:disabled) {
            background: #0052a3;
        }
        
        .input-container button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .loading {
            align-self: flex-start;
            padding: 0.75rem 1rem;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #888;
            font-style: italic;
        }
        
        .params {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 12px;
        }
        
        .params label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .params input[type="number"] {
            width: 60px;
            padding: 0.25rem;
            background: #333;
            border: 1px solid #444;
            color: #e0e0e0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="config">
            <input type="text" id="apiUrl" placeholder="API Base URL (z.B. http://192.168.200.46:8080)" />
            <select id="modelSelect">
                <option value="">Model laden...</option>
            </select>
            <button id="loadModels">Modelle laden</button>
            <button id="clearChat">Chat leeren</button>
        </div>
        <div class="params">
            <label>
                Max Tokens:
                <input type="number" id="maxTokens" value="500" min="1" max="32000" />
            </label>
            <label>
                Temperature:
                <input type="number" id="temperature" value="0.7" min="0" max="2" step="0.1" />
            </label>
        </div>
        <div id="status" class="status">Nicht verbunden</div>
    </div>
    
    <div id="chatContainer" class="chat-container">
        <div class="message system">
            Web-Chat Interface für OpenAI-kompatible APIs<br>
            Gib die Base URL ein und lade die verfügbaren Modelle.
        </div>
    </div>
    
    <div class="input-container">
        <textarea id="messageInput" placeholder="Nachricht eingeben... (Enter zum Senden, Shift+Enter für neue Zeile)"></textarea>
        <button id="sendButton">Senden</button>
    </div>

    <script>
        // State
        let messages = [];
        let currentModel = '';
        let isLoading = false;
        
        // Elements
        const apiUrlInput = document.getElementById('apiUrl');
        const modelSelect = document.getElementById('modelSelect');
        const loadModelsBtn = document.getElementById('loadModels');
        const clearChatBtn = document.getElementById('clearChat');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const statusEl = document.getElementById('status');
        const maxTokensInput = document.getElementById('maxTokens');
        const temperatureInput = document.getElementById('temperature');
        
        // Load from localStorage
        const savedUrl = localStorage.getItem('apiUrl');
        const savedModel = localStorage.getItem('model');
        if (savedUrl) apiUrlInput.value = savedUrl;
        
        // Normalize base URL (add /v1 if not present)
        function normalizeBaseUrl(url) {
            url = url.trim().replace(/\/+$/, ''); // Remove trailing slashes
            if (!url.endsWith('/v1')) {
                url += '/v1';
            }
            return url;
        }
        
        // Load models
        async function loadModels() {
            let baseUrl = apiUrlInput.value.trim();
            if (!baseUrl) {
                setStatus('Bitte API URL eingeben', 'error');
                return;
            }
            
            baseUrl = normalizeBaseUrl(baseUrl);
            
            try {
                setStatus('Lade Modelle...', '');
                const response = await fetch(`${baseUrl}/models`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const models = data.data || [];
                
                modelSelect.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    modelSelect.appendChild(option);
                });
                
                if (savedModel && models.find(m => m.id === savedModel)) {
                    modelSelect.value = savedModel;
                }
                
                if (models.length > 0) {
                    currentModel = modelSelect.value;
                    localStorage.setItem('apiUrl', baseUrl);
                    localStorage.setItem('model', currentModel);
                    setStatus(`✓ ${models.length} Model(e) geladen`, 'connected');
                } else {
                    setStatus('Keine Modelle gefunden', 'error');
                }
            } catch (err) {
                setStatus(`Fehler: ${err.message}`, 'error');
            }
        }
        
        // Send message
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || isLoading) return;
            
            let baseUrl = apiUrlInput.value.trim();
            currentModel = modelSelect.value;
            
            if (!baseUrl || !currentModel) {
                setStatus('Bitte API URL und Model auswählen', 'error');
                return;
            }
            
            baseUrl = normalizeBaseUrl(baseUrl);
            
            // Add user message
            messages.push({ role: 'user', content: text });
            addMessage('user', text);
            messageInput.value = '';
            
            // Show loading
            isLoading = true;
            const loadingEl = document.createElement('div');
            loadingEl.className = 'loading';
            loadingEl.textContent = 'Denkt nach...';
            chatContainer.appendChild(loadingEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            sendButton.disabled = true;
            
            try {
                const response = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: messages,
                        max_tokens: parseInt(maxTokensInput.value),
                        temperature: parseFloat(temperatureInput.value)
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }
                
                const data = await response.json();
                const assistantMsg = data.choices[0].message.content;
                
                messages.push({ role: 'assistant', content: assistantMsg });
                loadingEl.remove();
                addMessage('assistant', assistantMsg);
                
            } catch (err) {
                loadingEl.remove();
                addMessage('system', `❌ Fehler: ${err.message}`);
            } finally {
                isLoading = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }
        
        function addMessage(role, content) {
            const msgEl = document.createElement('div');
            msgEl.className = `message ${role}`;
            msgEl.textContent = content;
            chatContainer.appendChild(msgEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function clearChat() {
            messages = [];
            chatContainer.innerHTML = '<div class="message system">Chat geleert</div>';
        }
        
        function setStatus(text, type) {
            statusEl.textContent = text;
            statusEl.className = `status ${type}`;
        }
        
        // Event listeners
        loadModelsBtn.addEventListener('click', loadModels);
        clearChatBtn.addEventListener('click', clearChat);
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        modelSelect.addEventListener('change', () => {
            currentModel = modelSelect.value;
            localStorage.setItem('model', currentModel);
        });
        
        // Auto-load models if URL saved
        if (savedUrl) {
            loadModels();
        }
    </script>
</body>
</html>
